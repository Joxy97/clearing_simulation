# Quick Start: Client Debug Calculator

## Installation

```bash
# Navigate to visualizer directory
cd visualizer

# Install dependencies
pip install -r requirements.txt
```

## Running the Visualizer

```bash
# Start the Streamlit app
streamlit run app.py
```

The app will open at `http://localhost:8501`

## Using the Debug Calculator

### 1. Load Data
- Click "Browse files" in the sidebar
- Upload `simulation_output.json`

### 2. Select Day and Client
- Use the day slider to choose a simulation day
- Click the "Client Debug Calculator" tab
- Select a client from the dropdown (e.g., "CM - Client 1")

### 3. Review Calculations

The page shows 4 sections:

#### Section 1: PnL Calculation
- See how portfolio positions × returns = PnL
- Detailed breakdown per instrument
- ✅ if calculated matches reported

#### Section 2: Margin Calculation
- Expected Shortfall (ES) calculation
- Adjust alpha slider (90%-99%)
- View loss distribution histogram
- ✅ if calculated matches reported

#### Section 3: Shortfall & Margin Call
- Shows: margin required - collateral = shortfall
- Margin call status (called/accepted/liquidated)
- ✅ if calculated matches reported

#### Section 4: Wealth Tracking
- Wealth evolution breakdown
- Start + PnL + Income - Margin Calls = End

## Quick Examples

### Example 1: Verify a Client's PnL

**Question:** "Client 1 shows PnL of 1193.81. Is this correct?"

**Steps:**
1. Select "CM - Client 1"
2. Scroll to "PnL Calculation Breakdown"
3. Check the contribution table
4. Verify: Calculated PnL = 1193.81 ✅

### Example 2: Understand Why Client Got Margin Call

**Question:** "Why did Client 1 get a margin call?"

**Steps:**
1. Select "CM - Client 1"
2. Check "Margin Calculation Breakdown" → see margin = 4054.81
3. Check "Shortfall & Margin Call" → see collateral = 0.0
4. Shortfall = 4054.81 - 0.0 = 4054.81 → Margin call needed!

### Example 3: Investigate Different Confidence Levels

**Question:** "How does margin change if we use 95% confidence instead of 99%?"

**Steps:**
1. Select any client
2. Go to "Margin Calculation Breakdown"
3. Adjust alpha slider from 0.99 to 0.95
4. Watch calculated margin decrease (less tail risk coverage)
5. Expand "View Loss Distribution" to see VaR shift

## Key Formulas

### PnL
```
PnL = Σ(position[i] × return[i])
```

### Margin (Expected Shortfall)
```
1. Calculate losses = -PnL for each scenario
2. Sort losses
3. VaR = losses[α percentile]
4. ES = average(losses >= VaR)
5. Margin = ES
```

### Shortfall
```
Shortfall = max(0, Margin - Collateral)
```

### Wealth Evolution
```
Wealth_end = Wealth_start + PnL + Income - Margin_call
```

## Interpreting Results

### ✅ Green Checkmark
Calculated value matches reported value (difference < 0.01)
→ Calculation is correct!

### ⚠️ Warning Symbol
Calculated value differs from reported value
→ Investigate discrepancy (may be rounding, different alpha, or bug)

## Testing

Run the test suite to verify calculations:

```bash
cd visualizer
python3 test_calculations_standalone.py
```

Expected output:
```
=== PnL Calculation Test ===
Match: True ✅

=== Margin Calculation Test ===
Match: Calculations completed successfully ✅

=== Shortfall Calculation Test ===
[All tests pass] ✅

All tests completed successfully! ✅
```

## Files Overview

| File | Purpose |
|------|---------|
| `app.py` | Main visualizer with debug calculator |
| `simulation_output.json` | Sample data (generated by simulation) |
| `test_calculations_standalone.py` | Test suite for calculations |
| `CLIENT_DEBUG_CALCULATOR.md` | Comprehensive documentation |
| `IMPLEMENTATION_SUMMARY.md` | Technical implementation details |

## Troubleshooting

### No scenarios data available
→ Run simulation with `include_details=True` in config

### Client dropdown is empty
→ Select a different day or check if data has clients

### Calculations don't match
→ Check if alpha value matches simulation (usually 0.99)

## Next Steps

- Read [CLIENT_DEBUG_CALCULATOR.md](CLIENT_DEBUG_CALCULATOR.md) for detailed guide
- See [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) for technical details
- Explore other visualizer tabs: Overview, Market State, Trades, etc.

---

**Need help?** Check the comprehensive guide in `CLIENT_DEBUG_CALCULATOR.md`
